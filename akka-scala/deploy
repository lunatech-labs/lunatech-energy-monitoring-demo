#!/bin/bash

######################################################################
#
# Copy binary to all nodes or a specific single node
#
# Usage:
#   ./deploy [node-nr]
#
# Set CLUSTER_NR to the number of the cluster you're working with
# Default value of CLUSTER_NR is 0
######################################################################

RED='\033[1;31m'
GREEN='\033[1;32m'
RESET='\033[0m' # No Color

printError()
{
  echo -e "${RED}$@${RESET}"
}

printGreen()
{
  echo -e "${GREEN}$@${RESET}"
}

PI_USER=akkapi

# The artefact is a zip file generated by the native packager
# version number is stored in the 'version' file in the root of the repo
VERSION=`cat version`
ZipFileFQN=`ls digital-twins/target/universal/digital-twins*${VERSION}*zip 2>/dev/null`

# Check if an exercise was found with the given number, otherwise exit
if [ "Empty$ZipFileFQN" == "Empty" ]; then
  echo "No artifact at $1"
  exit -1
fi

eval IFS=/ read dum dum dum ZipFile <<< $ZipFileFQN
artifactName=$(echo $ZipFile | sed -e 's/.zip//')

ALL_NODES="0 1 2 3 4"
SELECTED_NODE=$2
NODES=${SELECTED_NODE:-$ALL_NODES}

# All artefacts are stored in a folder "applications" on the nodes
NodeBaseFolder=/home/${PI_USER}/applications

for i in $NODES;do
  node=$[ CLUSTER_BASE_NODE_NR + i ]
  account=${PI_USER}@node-${node}
  if [ ! $(ssh $account command -v unzip) ];then
    printError "ERROR: The 'unzip' command is missing on node-${node}: install it first by running the following command on node-${node}:"
    printError "          sudo apt-get install -y unzip"
  else
    ssh $account mkdir -p $NodeBaseFolder
    printGreen "Copy $ZipFile to node-$node"
    scp $ZipFileFQN $account:$NodeBaseFolder
    ssh $account rm -rf $NodeBaseFolder/$artifactName
    echo "Unzipping archive"
    ssh $account "cd $NodeBaseFolder; (unzip $ZipFile > /dev/null && rm $ZipFile)" &
  fi
done
